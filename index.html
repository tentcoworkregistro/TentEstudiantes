<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tent Cowork - Check-in/Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- ===== LIBRERÍAS AÑADIDAS ===== -->
    <!-- SheetJS (para exportar a Excel .xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Lucide Icons (para los iconos de los botones) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="module">
        // Configuración de Firebase con tus datos ya insertados
        const firebaseConfig = {
            apiKey: "AIzaSyC7Onnquc6p2_luPU_f9e9M0ltJ4eCXxp4",
            authDomain: "tentcowork-estudiantes.firebaseapp.com",
            projectId: "tentcowork-estudiantes",
            storageBucket: "tentcowork-estudiantes.appspot.com",
            messagingSenderId: "229032189557",
            appId: "1:229032189557:web:acc8a34f6d7ba62020223c",
            measurementId: "G-RSL9JYPJ76"
        };

        // Importaciones de Firebase (sin cambios)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, updateDoc, serverTimestamp, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const appId = 'tent-cowork-checkin'; 
        
        // --- Selectores de Elementos del DOM (sin cambios) ---
        const registrationSection = document.getElementById('registrationSection');
        const terminalSection = document.getElementById('terminalSection');
        const adminSection = document.getElementById('adminSection');
        const forgotCodeModal = document.getElementById('forgotCodeModal');
        const registrationForm = document.getElementById('registrationForm');
        const terminalForm = document.getElementById('terminalForm');
        const forgotCodeForm = document.getElementById('forgotCodeForm');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const codeDisplay = document.getElementById('codeDisplay');
        const mailtoButtonContainer = document.getElementById('mailtoButtonContainer');
        const studentStatusDiv = document.getElementById('studentStatusDiv');
        const adminContent = document.getElementById('adminContent');
        const closeOpenSessionsBtn = document.getElementById('closeOpenSessionsBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const terminalLoadingIndicator = document.getElementById('terminalLoadingIndicator');
        const forgotCodeLoadingIndicator = document.getElementById('forgotCodeLoadingIndicator');
        const adminLoadingIndicator = document.getElementById('adminLoadingIndicator');
        const forgotCodeMessageDiv = document.getElementById('forgotCodeMessageDiv');
        const adminMessageDiv = document.getElementById('adminMessageDiv');
        const recoveredCodeMailtoContainer = document.getElementById('recoveredCodeMailtoContainer');
        const showRegistrationBtn = document.getElementById('showRegistrationBtn');
        const showTerminalBtn = document.getElementById('showTerminalBtn');
        const openForgotCodeModalBtn = document.getElementById('openForgotCodeModalBtn');
        const closeForgotCodeModalBtn = document.getElementById('closeForgotCodeModalBtn');
        const tabNavigation = document.getElementById('tab-navigation');
        
        // --- Rutas de Colecciones de Firestore ---
        const studentsCollectionPath = `artifacts/${appId}/public/data/students`;
        const sessionsCollectionPath = `artifacts/${appId}/public/data/sessions`;

        // Configuración de Tailwind para colores personalizados (sin cambios)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tent-orange': '#F29F05',
                        'tent-green': '#014023',
                    }
                }
            }
        }
        
        // --- Lógica de Autenticación y Estado (sin cambios) ---
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user && user.email) {
                    console.log("Admin logueado:", user.email);
                    if(adminLoginForm) adminLoginForm.classList.add('hidden');
                    if(adminContent) adminContent.classList.remove('hidden');
                    loadAdminDataPanel(); 
                } else {
                    console.log("No hay admin logueado o es sesión anónima.");
                    if(adminLoginForm) adminLoginForm.classList.remove('hidden');
                    if(adminContent) adminContent.classList.add('hidden');
                    if (!auth.currentUser) {
                        signInAnonymously(auth).catch(error => console.error("Error en signInAnonymously:", error));
                    }
                }
            });
        }
        
        // Funciones de UI y Navegación (sin cambios)
        function showLoading(indicator) { if (indicator) indicator.classList.remove('hidden'); }
        function hideLoading(indicator) { if (indicator) indicator.classList.add('hidden'); }
        function showMessage(targetMessageContainer, message, type = 'success') {
            if (!targetMessageContainer) return;
            targetMessageContainer.classList.remove('hidden', 'bg-green-100', 'text-tent-green', 'bg-red-100', 'text-red-700', 'bg-yellow-100', 'text-yellow-800');
            if (type === 'success') { targetMessageContainer.classList.add('bg-green-100', 'text-tent-green'); }
            else if (type === 'error') { targetMessageContainer.classList.add('bg-red-100', 'text-red-700'); }
            else { targetMessageContainer.classList.add('bg-yellow-100', 'text-yellow-800'); }
            targetMessageContainer.textContent = message;
            setTimeout(() => { targetMessageContainer.classList.add('hidden'); }, 7000); 
        }
        const tabButtonInactiveClasses = ['bg-gray-100', 'text-gray-500', 'hover:bg-gray-200', 'hover:text-gray-700', 'border-transparent'];
        const tabButtonActiveClasses = ['bg-tent-green', 'text-white', 'shadow-md', 'border-tent-orange'];
        function styleTabButton(button, isActive) {
            if (!button) return;
            button.classList.remove(...tabButtonActiveClasses, ...tabButtonInactiveClasses); 
            if (isActive) { button.classList.add(...tabButtonActiveClasses); }
            else { button.classList.add(...tabButtonInactiveClasses); }
        }
        function navigateTo(sectionName) {
            if(registrationSection) registrationSection.classList.add('hidden');
            if(terminalSection) terminalSection.classList.add('hidden');
            if(adminSection) adminSection.classList.add('hidden');
            styleTabButton(showRegistrationBtn, false); 
            styleTabButton(showTerminalBtn, false);
            if (sectionName === 'registration') {
                if(registrationSection) registrationSection.classList.remove('hidden');
                styleTabButton(showRegistrationBtn, true); 
            } else if (sectionName === 'admin') {
                if(adminSection) adminSection.classList.remove('hidden');
            } else { 
                if(terminalSection) terminalSection.classList.remove('hidden');
                styleTabButton(showTerminalBtn, true); 
            }
        }
        function handleInitialNavigation() {
            const params = new URLSearchParams(window.location.search);
            const modo = params.get('modo');
            const view = params.get('view');
            if (modo === 'registro') {
                if (tabNavigation) tabNavigation.classList.add('hidden');
                navigateTo('registration');
            } else {
                if (tabNavigation) tabNavigation.classList.remove('hidden');
                navigateTo(view === 'admin' ? 'admin' : 'terminal');
            }
        }
        
        // --- Funciones de Lógica de la Aplicación (sin cambios) ---
        function generateAccessCode() { return Math.floor(10000 + Math.random() * 90000).toString(); }
        async function handleRegistrationSubmit(event) {
             event.preventDefault();
            if(loadingIndicator) showLoading(loadingIndicator);
            if(codeDisplay) codeDisplay.classList.add('hidden');
            if(mailtoButtonContainer) mailtoButtonContainer.classList.add('hidden');
            
            const messagePlaceholder = registrationSection ? registrationSection.querySelector('.message-placeholder') : null;
            const fullName = registrationForm.fullName.value.trim();
            const faculty = registrationForm.faculty.value.trim();
            const phone = registrationForm.phone.value.trim();
            const email = registrationForm.email.value.toLowerCase().trim();

            if (!fullName || !faculty || !email || !phone) {
                if(messagePlaceholder) showMessage(messagePlaceholder, 'Por favor, completa todos los campos obligatorios.', 'error');
                if(loadingIndicator) hideLoading(loadingIndicator); return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                if(messagePlaceholder) showMessage(messagePlaceholder, 'Por favor, ingresa un correo electrónico válido.', 'error');
                if(loadingIndicator) hideLoading(loadingIndicator); return;
            }
            if (!/^\+?[\d\s-]{7,15}$/.test(phone)) {
                if(messagePlaceholder) showMessage(messagePlaceholder, 'Por favor, ingresa un número de teléfono válido.', 'error');
                if(loadingIndicator) hideLoading(loadingIndicator); return;
            }
            try {
                const studentsRef = collection(db, studentsCollectionPath);
                const q = query(studentsRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    if(messagePlaceholder) showMessage(messagePlaceholder, 'Este correo electrónico ya está registrado. Puedes usar tu código actual o recuperarlo.', 'error');
                    if(loadingIndicator) hideLoading(loadingIndicator); return;
                }
                const accessCode = generateAccessCode(); 
                const studentData = { fullName, faculty, phone, email, accessCode, isCheckedIn: false, lastCheckInTimestamp: null, createdAt: serverTimestamp() };
                await addDoc(studentsRef, studentData);
                
                if(registrationForm) registrationForm.reset();
                if(codeDisplay) {
                    codeDisplay.innerHTML = `Tu código de acceso es: <strong class="text-2xl text-tent-orange">${accessCode}</strong>. ¡Guárdalo bien!`;
                    codeDisplay.classList.remove('hidden');
                }
                if(mailtoButtonContainer) {
                    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent('Tu código de acceso para Tent Cowork')}&body=${encodeURIComponent(`¡Hola ${fullName}!\n\nTu código de acceso para Tent Cowork es: ${accessCode}\n\nRecuerda este código para tus próximos ingresos.\n\n¡Te esperamos!\nEl equipo de Tent Cowork`)}`;
                    mailtoButtonContainer.innerHTML = `<a href="${mailtoLink}" class="mt-3 inline-block w-full text-center bg-tent-green hover:bg-opacity-80 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out">Enviarme el código a mi email</a>`;
                    mailtoButtonContainer.classList.remove('hidden');
                }
                if(messagePlaceholder) showMessage(messagePlaceholder, `¡Registro exitoso, ${fullName}! Revisa tu código arriba y puedes auto-enviártelo por email.`, 'success');
            } catch (error) {
                console.error("Error al registrar estudiante: ", error);
                if(messagePlaceholder) showMessage(messagePlaceholder, 'Error al registrar. Inténtalo de nuevo.', 'error');
            } finally { if(loadingIndicator) hideLoading(loadingIndicator); }
        }
        async function handleTerminalSubmit(event) {
            event.preventDefault();
            if(terminalLoadingIndicator) showLoading(terminalLoadingIndicator);
            if(studentStatusDiv) studentStatusDiv.classList.add('hidden');
            
            const messagePlaceholder = terminalSection ? terminalSection.querySelector('.message-placeholder') : null;
            const accessCodeInput = terminalForm.accessCode.value.trim();

            if (accessCodeInput.length !== 5 || !/^\d+$/.test(accessCodeInput)) {
                if(messagePlaceholder) showMessage(messagePlaceholder, 'Ingresa un código de acceso válido de 5 dígitos.', 'error');
                if(terminalLoadingIndicator) hideLoading(terminalLoadingIndicator); return;
            }
            try {
                const studentsRef = collection(db, studentsCollectionPath);
                const q = query(studentsRef, where("accessCode", "==", accessCodeInput));
                const studentQuerySnapshot = await getDocs(q);
                if (studentQuerySnapshot.empty) {
                    if(messagePlaceholder) showMessage(messagePlaceholder, 'Código de acceso no encontrado.', 'error');
                    if(terminalLoadingIndicator) hideLoading(terminalLoadingIndicator); 
                    if(terminalForm) terminalForm.reset(); 
                    return;
                }
                const studentDoc = studentQuerySnapshot.docs[0];
                const student = studentDoc.data();
                const studentId = studentDoc.id;
                const sessionsRef = collection(db, sessionsCollectionPath);

                if (!student.isCheckedIn) {
                    await updateDoc(doc(db, studentsCollectionPath, studentId), { isCheckedIn: true, lastCheckInTimestamp: serverTimestamp() });
                    await addDoc(sessionsRef, { studentId: studentId, fullName: student.fullName, email: student.email, checkInTimestamp: serverTimestamp(), checkOutTimestamp: null, durationMinutes: null });
                    if(messagePlaceholder) showMessage(messagePlaceholder, `¡Bienvenido, ${student.fullName}! Check-in realizado.`, 'success');
                    if(studentStatusDiv) {
                        studentStatusDiv.innerHTML = `Hola ${student.fullName}.<br>Estás <span class="font-bold text-tent-green">DENTRO</span>.`;
                        studentStatusDiv.classList.remove('hidden');
                    }
                } else {
                    await updateDoc(doc(db, studentsCollectionPath, studentId), { isCheckedIn: false });
                    const activeSessionQuery = query(sessionsRef, where("studentId", "==", studentId), where("checkOutTimestamp", "==", null));
                    const activeSessionSnapshot = await getDocs(activeSessionQuery);
                    if (!activeSessionSnapshot.empty) {
                        const sessionDocToUpdate = activeSessionSnapshot.docs[0]; 
                        const sessionData = sessionDocToUpdate.data();
                        const checkInTime = sessionData.checkInTimestamp.toDate();
                        const checkOutTime = new Date();
                        const durationMs = checkOutTime - checkInTime;
                        const durationMinutes = Math.max(0, Math.round(durationMs / 60000));
                        await updateDoc(doc(db, sessionsCollectionPath, sessionDocToUpdate.id), { checkOutTimestamp: serverTimestamp(), durationMinutes: durationMinutes });
                        if(messagePlaceholder) showMessage(messagePlaceholder, `¡Hasta luego, ${student.fullName}! Check-out realizado. Duración: ${durationMinutes} min.`, 'success');
                    } else {
                        if(messagePlaceholder) showMessage(messagePlaceholder, `¡Hasta luego, ${student.fullName}! Check-out realizado. (No se encontró sesión activa para calcular duración).`, 'info');
                    }
                    if(studentStatusDiv){
                        studentStatusDiv.innerHTML = `Hola ${student.fullName}.<br>Estás <span class="font-bold text-red-600">FUERA</span>.`;
                        studentStatusDiv.classList.remove('hidden');
                    }
                }
                if(terminalForm) terminalForm.reset();
            } catch (error) {
                console.error("Error en el terminal: ", error);
                if(messagePlaceholder) showMessage(messagePlaceholder, 'Error en la operación. Inténtalo de nuevo.', 'error');
            } finally { if(terminalLoadingIndicator) hideLoading(terminalLoadingIndicator); }
        }
        async function handleCheckStatus() {
            const messagePlaceholder = terminalSection ? terminalSection.querySelector('.message-placeholder') : null;
            const accessCodeInput = terminalForm.accessCode.value.trim();
            if (accessCodeInput.length !== 5 || !/^\d+$/.test(accessCodeInput)) {
                if(messagePlaceholder) showMessage(messagePlaceholder, 'Ingresa un código válido para ver tu estado.', 'error'); return;
            }
            if(terminalLoadingIndicator) showLoading(terminalLoadingIndicator);
            if(studentStatusDiv) studentStatusDiv.classList.add('hidden');
            try {
                const studentsRef = collection(db, studentsCollectionPath);
                const q = query(studentsRef, where("accessCode", "==", accessCodeInput));
                const studentQuerySnapshot = await getDocs(q);
                if (studentQuerySnapshot.empty) {
                    if(messagePlaceholder) showMessage(messagePlaceholder, 'Código no encontrado.', 'error');
                    if(terminalLoadingIndicator) hideLoading(terminalLoadingIndicator); return;
                }
                const student = studentQuerySnapshot.docs[0].data();
                const status = student.isCheckedIn ? `<span class="font-bold text-tent-green">DENTRO</span>` : `<span class="font-bold text-red-600">FUERA</span>`;
                if(studentStatusDiv){
                    studentStatusDiv.innerHTML = `Hola ${student.fullName}.<br>Actualmente estás ${status}.`;
                    studentStatusDiv.classList.remove('hidden');
                }
                if(messagePlaceholder) showMessage(messagePlaceholder, `Estado consultado para ${student.fullName}.`, 'info');
            } catch (error) {
                console.error("Error al consultar estado: ", error);
                if(messagePlaceholder) showMessage(messagePlaceholder, 'Error al consultar estado.', 'error');
            } finally { if(terminalLoadingIndicator) hideLoading(terminalLoadingIndicator); }
        }
        async function handleForgotCodeSubmit(event) {
            event.preventDefault();
            if(forgotCodeLoadingIndicator) showLoading(forgotCodeLoadingIndicator);
            if(forgotCodeMessageDiv) forgotCodeMessageDiv.classList.add('hidden');
            if(recoveredCodeMailtoContainer) recoveredCodeMailtoContainer.classList.add('hidden');

            const email = forgotCodeForm.recoveryEmail.value.toLowerCase().trim();
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                if(forgotCodeMessageDiv) showMessage(forgotCodeMessageDiv, 'Por favor, ingresa un correo electrónico válido.', 'error');
                if(forgotCodeLoadingIndicator) hideLoading(loadingIndicator);
                return;
            }
            try {
                const studentsRef = collection(db, studentsCollectionPath);
                const q = query(studentsRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    if(forgotCodeMessageDiv) showMessage(forgotCodeMessageDiv, 'Correo electrónico no encontrado en nuestros registros.', 'error');
                } else {
                    const studentData = querySnapshot.docs[0].data();
                    const accessCode = studentData.accessCode;
                    const fullName = studentData.fullName;
                    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent('Recordatorio de tu código para Tent Cowork')}&body=${encodeURIComponent(`¡Hola ${fullName}!\n\nHas solicitado un recordatorio de tu código de acceso para Tent Cowork.\n\nTu código es: ${accessCode}\n\n¡Te esperamos!\nEl equipo de Tent Cowork`)}`;
                    if(recoveredCodeMailtoContainer){
                        recoveredCodeMailtoContainer.innerHTML = `<p class="text-sm text-gray-600 mb-2">Encontramos tu código. Haz clic abajo para enviártelo a tu email:</p><a href="${mailtoLink}" class="mt-3 inline-block w-full text-center bg-tent-green hover:bg-opacity-80 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out">Enviarme mi código: ${accessCode}</a>`;
                        recoveredCodeMailtoContainer.classList.remove('hidden');
                    }
                    if(forgotCodeMessageDiv) showMessage(forgotCodeMessageDiv, `¡Hola ${fullName}! Hemos encontrado tu código.`, 'success');
                }
            } catch (error) {
                console.error("Error al recuperar código: ", error);
                if(forgotCodeMessageDiv) showMessage(forgotCodeMessageDiv, 'Error al intentar recuperar el código. Inténtalo de nuevo.', 'error');
            } finally {
                if(forgotCodeLoadingIndicator) hideLoading(forgotCodeLoadingIndicator);
            }
        }
        async function handleAdminLogin(event) {
            event.preventDefault();
            showLoading(adminLoadingIndicator);
            const email = adminLoginForm.adminEmail.value;
            const password = adminLoginForm.adminPassword.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage(adminMessageDiv, 'Inicio de sesión exitoso.', 'success');
            } catch (error) {
                console.error("Error de inicio de sesión de admin:", error);
                let errorMessage = 'Email o contraseña incorrectos.';
                if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Las credenciales proporcionadas son incorrectas.';
                }
                showMessage(adminMessageDiv, errorMessage, 'error');
            } finally {
                hideLoading(adminLoadingIndicator);
            }
        }
        async function handleAdminLogout() {
            try {
                await signOut(auth);
                showMessage(adminMessageDiv, 'Has cerrado sesión.', 'info');
            } catch (error) {
                console.error("Error al cerrar sesión de admin:", error);
                showMessage(adminMessageDiv, 'No se pudo cerrar sesión.', 'error');
            }
        }
        async function handleCloseOpenSessions() {
            if (!document.getElementById('confirmCloseCheckbox').checked) {
                showMessage(adminMessageDiv, 'Por favor, marca la casilla para confirmar la operación.', 'error');
                return;
            }
            showLoading(adminLoadingIndicator);
            try {
                const sessionsRef = collection(db, sessionsCollectionPath);
                const q = query(sessionsRef, where("checkOutTimestamp", "==", null));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage(adminMessageDiv, 'No se encontraron sesiones abiertas para cerrar.', 'info');
                } else {
                    const updatePromises = [];
                    const studentUpdateMap = new Map();
                    querySnapshot.forEach(sessionDoc => {
                        const session = sessionDoc.data();
                        const checkInDate = session.checkInTimestamp.toDate();
                        const closingDate = new Date(checkInDate);
                        closingDate.setHours(21, 30, 0, 0);
                        const durationMs = closingDate.getTime() - checkInDate.getTime();
                        const durationMinutes = Math.max(0, Math.round(durationMs / 60000));
                        updatePromises.push(updateDoc(doc(db, sessionsCollectionPath, sessionDoc.id), {
                            checkOutTimestamp: Timestamp.fromDate(closingDate),
                            durationMinutes: durationMinutes
                        }));
                        if (session.studentId) studentUpdateMap.set(session.studentId, false); 
                    });
                    studentUpdateMap.forEach((status, studentId) => {
                        updatePromises.push(updateDoc(doc(db, studentsCollectionPath, studentId), { isCheckedIn: status }));
                    });
                    await Promise.all(updatePromises);
                    showMessage(adminMessageDiv, `Cierre completado. Se actualizaron ${querySnapshot.size} sesiones.`, 'success');
                }
            } catch (error) {
                console.error("Error al cerrar sesiones abiertas:", error);
                showMessage(adminMessageDiv, 'Ocurrió un error durante el cierre de sesiones.', 'error');
            } finally {
                hideLoading(adminLoadingIndicator);
                document.getElementById('confirmCloseCheckbox').checked = false;
            }
        }
        
        // --- ===== FUNCIONES DEL PANEL DE DATOS (MODIFICADAS) ===== ---

        let allUsers = [];
        let allSessions = [];

        function renderUsersTable(users) {
            const usersTableBody = document.getElementById('usersTableBody');
            if(!usersTableBody) return;
            usersTableBody.innerHTML = '';
            users.forEach(userData => {
                const row = `
                    <tr class="hover:bg-slate-50 transition-colors duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${userData.fullName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${userData.faculty || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${userData.email || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${userData.phone || 'N/A'}</td>
                    </tr>`;
                usersTableBody.innerHTML += row;
            });
        }

        function renderSessionsTable(sessions) {
            const sessionsTableBody = document.getElementById('sessionsTableBody');
            if(!sessionsTableBody) return;
            sessionsTableBody.innerHTML = '';
            sessions.forEach(sessionData => {
                 const row = `
                    <tr class="hover:bg-slate-50 transition-colors duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${sessionData.user.fullName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${formatTimestampForPanel(sessionData.checkInTimestamp)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${formatTimestampForPanel(sessionData.checkOutTimestamp)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${formatDurationForDisplay(calculateDurationForPanel(sessionData.checkInTimestamp, sessionData.checkOutTimestamp))}</td>
                    </tr>`;
                sessionsTableBody.innerHTML += row;
            });
        }
        
        function formatTimestampForPanel(timestamp) {
            if (!timestamp || typeof timestamp.toDate !== 'function') return 'N/A';
            return timestamp.toDate().toLocaleString('es-AR', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false
            });
        }

        function calculateDurationForPanel(startTime, endTime) {
            if (!startTime || !endTime || typeof startTime.toDate !== 'function' || typeof endTime.toDate !== 'function') return 'En curso';
            const diffMs = endTime.toDate() - startTime.toDate();
            if (diffMs < 0) return 0; // Return 0 for invalid duration
            return Math.floor(diffMs / 1000); // Return duration in seconds
        }
        
        function formatDurationForDisplay(totalSeconds) {
            if (totalSeconds === 'En curso' || isNaN(totalSeconds)) return 'En curso';
             const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m`;
        }

        async function fetchAndRenderUsers() {
            const usersLoader = document.getElementById('usersLoader');
            const usersTableContainer = document.getElementById('usersTableContainer');
            const usersError = document.getElementById('usersError');
            
            try {
                const usersCollectionRef = collection(db, studentsCollectionPath);
                const querySnapshot = await getDocs(usersCollectionRef);
                const usersMap = new Map();
                allUsers = [];

                querySnapshot.forEach(doc => {
                    const userData = doc.data();
                    const enrichedUserData = {
                        ...userData,
                        id: doc.id,
                        fullName: userData.fullName || `${userData.name || ''} ${userData.lastName || ''}`.trim()
                    };
                    allUsers.push(enrichedUserData);
                    usersMap.set(doc.id, enrichedUserData);
                });

                if (querySnapshot.empty) {
                   if(usersError) { usersError.textContent = "No se encontraron usuarios registrados."; usersError.classList.remove('hidden'); }
                } else {
                    if(usersTableContainer) usersTableContainer.classList.remove('hidden');
                    renderUsersTable(allUsers);
                }
                return usersMap;
            } catch (error) {
                console.error("Error fetching users:", error);
                if(usersError) { usersError.textContent = "Error al cargar los usuarios."; usersError.classList.remove('hidden'); }
                return new Map();
            } finally {
                if(usersLoader) usersLoader.classList.add('hidden');
            }
        }
        
        async function fetchAndRenderSessions(usersMap) {
            const sessionsLoader = document.getElementById('sessionsLoader');
            const sessionsTableContainer = document.getElementById('sessionsTableContainer');
            const sessionsError = document.getElementById('sessionsError');
            
            try {
                const sessionsCollectionRef = collection(db, sessionsCollectionPath);
                const querySnapshot = await getDocs(sessionsCollectionRef);
                allSessions = [];

                querySnapshot.forEach(doc => {
                    const sessionData = doc.data();
                    allSessions.push({
                        ...sessionData,
                        id: doc.id,
                        user: usersMap.get(sessionData.studentId) || { fullName: 'Usuario Desconocido' }
                    });
                });
                
                if (querySnapshot.empty) {
                   if(sessionsError) { sessionsError.textContent = "No se encontraron sesiones."; sessionsError.classList.remove('hidden'); }
                } else {
                    if(sessionsTableContainer) sessionsTableContainer.classList.remove('hidden');
                     renderSessionsTable(allSessions);
                }
            } catch (error) {
                console.error("Error fetching sessions:", error);
                if(sessionsError) { sessionsError.textContent = "Error al cargar las sesiones."; sessionsError.classList.remove('hidden'); }
            } finally {
                if(sessionsLoader) sessionsLoader.classList.add('hidden');
            }
        }
        
        function exportToXLSX(data, filename) {
             if (data.length === 0) {
                showMessage(adminMessageDiv, "No hay datos en la tabla para exportar.", "info");
                return;
            }

            // Create a deep copy for manipulation
            const dataForExport = JSON.parse(JSON.stringify(data));

            // Format data for export
            const formattedData = dataForExport.map(item => {
                if (filename.includes('sesiones')) {
                    return {
                        "Nombre y Apellido": item.user?.fullName || 'N/A',
                        "Entrada": item.checkInTimestamp ? formatTimestampForPanel(new Timestamp(item.checkInTimestamp.seconds, item.checkInTimestamp.nanoseconds)) : 'N/A',
                        "Salida": item.checkOutTimestamp ? formatTimestampForPanel(new Timestamp(item.checkOutTimestamp.seconds, item.checkOutTimestamp.nanoseconds)) : 'N/A',
                        "Tiempo Total": formatDurationForDisplay(calculateDurationForPanel(item.checkInTimestamp, item.checkOutTimestamp))
                    };
                }
                return { // For students
                    "Nombre y Apellido": item.fullName,
                    "Facultad": item.faculty || 'N/A',
                    "Gmail": item.email || 'N/A',
                    "Número de Teléfono": item.phone || 'N/A'
                };
            });
            
            const worksheet = XLSX.utils.json_to_sheet(formattedData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Datos");
            XLSX.writeFile(workbook, `${filename}_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        function sortData(data, column, direction) {
            const collator = new Intl.Collator('es', { numeric: true, sensitivity: 'base' });
            data.sort((a, b) => {
                let valA, valB;

                if (column === 'checkInTimestamp' || column === 'checkOutTimestamp') {
                    valA = a[column] ? a[column].seconds : 0;
                    valB = b[column] ? b[column].seconds : 0;
                } else if (column === 'duration') {
                    valA = calculateDurationForPanel(a.checkInTimestamp, a.checkOutTimestamp);
                    valB = calculateDurationForPanel(b.checkInTimestamp, b.checkOutTimestamp);
                } else if (column === 'fullName' && 'user' in a) { // For sessions table
                    valA = a.user.fullName;
                    valB = b.user.fullName;
                } else {
                    valA = a[column];
                    valB = b[column];
                }

                // Handle cases where values might be undefined or null
                if (valA == null) valA = typeof valA === 'string' ? '' : -Infinity;
                if (valB == null) valB = typeof valB === 'string' ? '' : -Infinity;

                if (typeof valA === 'string' && typeof valB === 'string') {
                    return direction === 'asc' ? collator.compare(valA, valB) : collator.compare(valB, valA);
                } else {
                    return direction === 'asc' ? valA - valB : valB - valA;
                }
            });
        }


        function setupTableSorting() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.column;
                    const tableId = header.closest('table').id;
                    let currentDirection = header.dataset.direction;
                    
                    // Reset other headers
                    header.closest('thead').querySelectorAll('.sortable-header').forEach(h => {
                        if (h !== header) {
                            h.dataset.direction = 'none';
                             h.querySelector('.sort-icon').innerHTML = `<i data-lucide="chevrons-up-down"></i>`;
                        }
                    });

                    // Toggle direction
                    const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                    header.dataset.direction = newDirection;
                    header.querySelector('.sort-icon').innerHTML = newDirection === 'asc' ? `<i data-lucide="chevron-up"></i>` : `<i data-lucide="chevron-down"></i>`;

                    if (tableId === 'usersTable') {
                        sortData(allUsers, column, newDirection);
                        renderUsersTable(allUsers);
                    } else if (tableId === 'sessionsTable') {
                        sortData(allSessions, column, newDirection);
                        renderSessionsTable(allSessions);
                    }
                     if (typeof lucide !== 'undefined') lucide.createIcons();
                });
            });
        }

        async function loadAdminDataPanel() {
            const dataPanel = document.getElementById('data-panel');
            if (dataPanel && dataPanel.getAttribute('data-loaded') === 'true') {
                return;
            }

            const usersMap = await fetchAndRenderUsers();
            if (usersMap.size > 0) {
                await fetchAndRenderSessions(usersMap);
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            setupTableSorting(); // Setup sorting after data is loaded

            if (dataPanel) dataPanel.setAttribute('data-loaded', 'true');
        }

        // --- Inicialización y Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            setupAuthListener(); 
            handleInitialNavigation(); 

            if (showRegistrationBtn) showRegistrationBtn.addEventListener('click', () => navigateTo('registration'));
            if (showTerminalBtn) showTerminalBtn.addEventListener('click', () => navigateTo('terminal'));
            if (registrationForm) registrationForm.addEventListener('submit', handleRegistrationSubmit);
            if (terminalForm) terminalForm.addEventListener('submit', handleTerminalSubmit);
            if (forgotCodeForm) forgotCodeForm.addEventListener('submit', handleForgotCodeSubmit);
            const checkStatusCodeBtn = document.getElementById('checkStatusCodeBtn');
            if (checkStatusCodeBtn) checkStatusCodeBtn.addEventListener('click', handleCheckStatus);
            if (openForgotCodeModalBtn) openForgotCodeModalBtn.addEventListener('click', () => { if(forgotCodeModal) forgotCodeModal.classList.remove('hidden'); });
            if (closeForgotCodeModalBtn) closeForgotCodeModalBtn.addEventListener('click', () => {
                if(forgotCodeModal) forgotCodeModal.classList.add('hidden'); if(forgotCodeForm) forgotCodeForm.reset(); if(forgotCodeMessageDiv) forgotCodeMessageDiv.classList.add('hidden'); if(recoveredCodeMailtoContainer) recoveredCodeMailtoContainer.classList.add('hidden');
            });
            if (forgotCodeModal) {
                forgotCodeModal.addEventListener('click', (event) => { if (event.target === forgotCodeModal) { if(closeForgotCodeModalBtn) closeForgotCodeModalBtn.click(); } });
            }
            
            if (adminLoginForm) adminLoginForm.addEventListener('submit', handleAdminLogin);
            if (closeOpenSessionsBtn) closeOpenSessionsBtn.addEventListener('click', handleCloseOpenSessions);
            if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', handleAdminLogout);
            
            const exportUsersBtn = document.getElementById('exportUsersBtn');
            if(exportUsersBtn) exportUsersBtn.addEventListener('click', () => exportToXLSX(allUsers, 'estudiantes_registrados'));
            
            const exportSessionsBtn = document.getElementById('exportSessionsBtn');
            if(exportSessionsBtn) exportSessionsBtn.addEventListener('click', () => exportToXLSX(allSessions, 'sesiones_cowork'));

            const currentYearSpan = document.getElementById('currentYear');
            if (currentYearSpan) {
                currentYearSpan.textContent = new Date().getFullYear();
            }
        });

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* ===== NUEVOS ESTILOS PARA EL PANEL DE DATOS ===== */
        :root { --tent-orange: #F29F05; --tent-green: #014023; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1); border-top: 4px solid var(--tent-orange); transition: all 0.3s ease-in-out; }
        .card:hover { box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); transform: translateY(-2px); }
        .btn-primary { background-color: var(--tent-orange); color: white; font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgba(242, 159, 5, 0.3), 0 2px 4px -2px rgba(242, 159, 5, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(242, 159, 5, 0.3), 0 4px 6px -4px rgba(242, 159, 5, 0.2); }
        .table-header { background-color: var(--tent-green); color: #f8fafc; }
        th.sortable-header { cursor: pointer; }
        th .sort-icon { color: #9ca3af; }
        th[data-direction="asc"] .sort-icon, th[data-direction="desc"] .sort-icon { color: white; }
        th { position: sticky; top: 0; z-index: 10; }
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #e2e8f0; }
        .table-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4 selection:bg-tent-orange selection:text-white">

    <div class="w-full max-w-4xl bg-white shadow-xl rounded-lg p-6 relative"> 
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-tent-orange">Tent Cowork</h1>
            <p class="text-gray-600">Sistema de Check-in / Check-out</p>
        </header>

        <div id="tab-navigation" class="mb-4 border-b border-gray-300">
            <nav class="flex -mb-px">
                <button id="showTerminalBtn" class="px-6 py-3 font-semibold transition-all duration-150 ease-in-out focus:outline-none rounded-t-md border-b-2">Terminal</button>
                <button id="showRegistrationBtn" class="px-6 py-3 font-semibold transition-all duration-150 ease-in-out focus:outline-none rounded-t-md border-b-2">Registrarse</button>
            </nav>
        </div>
        
        <!-- Secciones de Terminal y Registro (sin cambios en su HTML) -->
        <section id="terminalSection" class="hidden pt-4 max-w-md mx-auto">
            <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Ingresa tu Código</h2>
            <div class="message-placeholder p-3 rounded-md text-sm mb-4 hidden"></div> 
            <form id="terminalForm" class="space-y-4">
                <div>
                    <label for="accessCodeTerminal" class="sr-only">Código de Acceso</label>
                    <input type="text" id="accessCodeTerminal" name="accessCode" inputmode="numeric" pattern="[0-9]*" maxlength="5" class="w-full p-4 text-3xl text-center bg-gray-100 border-2 border-gray-300 rounded-lg shadow-inner focus:ring-tent-orange focus:border-tent-orange focus:bg-white placeholder-gray-400 transition-colors duration-150" placeholder="•••••" required>
                </div>
                <button type="submit" class="w-full bg-tent-orange hover:bg-opacity-80 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-tent-orange focus:ring-opacity-50 transform hover:scale-105">Registrar Entrada / Salida</button>
                <button type="button" id="checkStatusCodeBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm transform hover:scale-105">Consultar mi Estado</button>
            </form>
            <div class="text-center mt-3">
                <button type="button" id="openForgotCodeModalBtn" class="text-sm text-tent-orange hover:text-opacity-80 hover:underline">¿Olvidaste tu código?</button>
            </div>
            <div id="terminalLoadingIndicator" class="text-center mt-4 hidden"><div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-tent-orange"></div><p class="text-sm text-gray-500">Procesando...</p></div>
            <div id="studentStatusDiv" class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-md text-center text-gray-700 hidden"></div>
        </section>

        <section id="registrationSection" class="hidden pt-4 max-w-md mx-auto">
            <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Registro de Estudiante</h2>
            <div class="message-placeholder p-3 rounded-md text-sm mb-4 hidden"></div> 
            <form id="registrationForm" class="space-y-3">
                <div><label for="fullName" class="block text-sm font-medium text-gray-700">Nombre Completo*</label><input type="text" id="fullName" name="fullName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-tent-orange focus:border-tent-orange sm:text-sm" required></div>
                <div><label for="faculty" class="block text-sm font-medium text-gray-700">Facultad*</label><input type="text" id="faculty" name="faculty" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-tent-orange focus:border-tent-orange sm:text-sm" required></div>
                <div><label for="phone" class="block text-sm font-medium text-gray-700">Número de Teléfono*</label><input type="tel" id="phone" name="phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-tent-orange focus:border-tent-orange sm:text-sm" required></div>
                <div><label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico*</label><input type="email" id="email" name="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-tent-orange focus:border-tent-orange sm:text-sm" required></div>
                <button type="submit" class="w-full bg-tent-orange hover:bg-opacity-80 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all">Registrarme y Obtener Código</button>
            </form>
            <div id="loadingIndicator" class="text-center mt-4 hidden"><div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-tent-orange"></div><p class="text-sm text-gray-500">Registrando...</p></div>
            <div id="codeDisplay" class="mt-4 p-4 bg-yellow-50 border-yellow-200 rounded-md text-center text-yellow-800 hidden"></div>
            <div id="mailtoButtonContainer" class="hidden mt-2"></div>
        </section>
        
        <!-- Sección de Administrador -->
        <section id="adminSection" class="hidden pt-4">
            <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Panel de Administración</h2>
            <div class="message-placeholder p-3 rounded-md text-sm mb-4 hidden" id="adminMessageDiv"></div> 
            <form id="adminLoginForm" class="space-y-4 bg-gray-50 p-4 rounded-lg border max-w-md mx-auto">
                <div><label for="adminEmail" class="block text-sm font-medium text-gray-700">Email de Administrador</label><input type="email" id="adminEmail" name="adminEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div><label for="adminPassword" class="block text-sm font-medium text-gray-700">Contraseña</label><input type="password" id="adminPassword" name="adminPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                <button type="submit" class="w-full bg-tent-green hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-lg shadow-md">Iniciar Sesión</button>
            </form>

            <div id="adminContent" class="hidden space-y-6">
                <div class="max-w-md mx-auto space-y-4">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 rounded-md" role="alert">
                        <p class="font-bold">Acción Crítica</p>
                        <p>Esta acción cerrará todas las sesiones que actualmente estén abiertas a las 21:30.</p>
                    </div>
                    <div class="flex items-center"><input id="confirmCloseCheckbox" type="checkbox" class="h-4 w-4 text-tent-orange focus:ring-tent-orange border-gray-300 rounded"><label for="confirmCloseCheckbox" class="ml-2 block text-sm text-gray-900">Entiendo y quiero cerrar todas las sesiones abiertas.</label></div>
                    <button type="button" id="closeOpenSessionsBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md">Cerrar Sesiones Abiertas</button>
                </div>
                <hr/>
                <div id="data-panel" data-loaded="false" class="space-y-8">
                    <div class="card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-5"><h2 class="text-2xl font-bold mb-3 sm:mb-0" style="color: var(--tent-green);">Estudiantes Registrados</h2><button id="exportUsersBtn" class="btn-primary"><i data-lucide="download"></i>Exportar</button></div>
                        <div id="usersLoader" class="flex justify-center items-center py-12"><div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-tent-green"></div></div>
                        <div id="usersTableContainer" class="table-container overflow-x-auto max-h-[60vh] rounded-lg border border-slate-200 hidden">
                            <table id="usersTable" class="min-w-full divide-y divide-slate-200"><thead class="table-header"><tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider sortable-header" data-column="fullName" data-direction="none"><div class="flex items-center"><span>Nombre y Apellido</span><span class="sort-icon ml-2"><i data-lucide="chevrons-up-down"></i></span></div></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider sortable-header" data-column="faculty" data-direction="none"><div class="flex items-center"><span>Facultad</span><span class="sort-icon ml-2"><i data-lucide="chevrons-up-down"></i></span></div></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider sortable-header" data-column="email" data-direction="none"><div class="flex items-center"><span>Gmail</span><span class="sort-icon ml-2"><i data-lucide="chevrons-up-down"></i></span></div></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Teléfono</th>
                            </tr></thead><tbody id="usersTableBody" class="bg-white divide-y divide-slate-200"></tbody></table>
                        </div>
                        <p id="usersError" class="text-center text-red-600 font-medium py-4 hidden"></p>
                    </div>
                    <div class="card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-5"><h2 class="text-2xl font-bold mb-3 sm:mb-0" style="color: var(--tent-green);">Sesiones de Check-in/Out</h2><button id="exportSessionsBtn" class="btn-primary"><i data-lucide="download"></i>Exportar</button></div>
                        <div id="sessionsLoader" class="flex justify-center items-center py-12"><div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-tent-green"></div></div>
                        <div id="sessionsTableContainer" class="table-container overflow-x-auto max-h-[60vh] rounded-lg border border-slate-200 hidden">
                            <table id="sessionsTable" class="min-w-full divide-y divide-slate-200"><thead class="table-header"><tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider sortable-header" data-column="fullName" data-direction="none"><div class="flex items-center"><span>Nombre y Apellido</span><span class="sort-icon ml-2"><i data-lucide="chevrons-up-down"></i></span></div></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider sortable-header" data-column="checkInTimestamp" data-direction="none"><div class="flex items-center"><span>Entrada</span><span class="sort-icon ml-2"><i data-lucide="chevrons-up-down"></i></span></div></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider sortable-header" data-column="checkOutTimestamp" data-direction="none"><div class="flex items-center"><span>Salida</span><span class="sort-icon ml-2"><i data-lucide="chevrons-up-down"></i></span></div></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider sortable-header" data-column="duration" data-direction="none"><div class="flex items-center"><span>Tiempo Total</span><span class="sort-icon ml-2"><i data-lucide="chevrons-up-down"></i></span></div></th>
                            </tr></thead><tbody id="sessionsTableBody" class="bg-white divide-y divide-slate-200"></tbody></table>
                        </div>
                        <p id="sessionsError" class="text-center text-red-600 font-medium py-4 hidden"></p>
                    </div>
                </div>
                <hr/>
                <div class="max-w-md mx-auto">
                    <button type="button" id="adminLogoutBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md text-sm">Cerrar Sesión de Admin</button>
                </div>
            </div>
            <div id="adminLoadingIndicator" class="text-center mt-4 hidden"><div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-red-600"></div><p class="text-sm text-gray-500">Procesando...</p></div>
        </section>

        <footer class="mt-8 text-center text-sm text-gray-500"><p>&copy; <span id="currentYear"></span> Tent Cowork. Todos los derechos reservados.</p></footer>
    </div>
    
    <div id="forgotCodeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="flex justify-between items-center mb-4"><h3 class="text-lg leading-6 font-medium text-gray-900">Recuperar Código de Acceso</h3><button id="closeForgotCodeModalBtn" type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div>
                <form id="forgotCodeForm" class="space-y-4">
                    <div><label for="recoveryEmail" class="sr-only">Correo Electrónico de Registro</label><input type="email" name="recoveryEmail" id="recoveryEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-tent-orange focus:border-tent-orange sm:text-sm bg-gray-50" placeholder="Ingresa tu email de registro" required></div>
                    <button type="submit" class="w-full text-white bg-tent-orange hover:bg-opacity-80 focus:ring-4 focus:outline-none focus:ring-tent-orange font-medium rounded-lg text-sm px-5 py-2.5 text-center">Buscar mi Código</button>
                </form>
                <div id="forgotCodeLoadingIndicator" class="text-center mt-4 hidden"><div class="inline-block animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-tent-orange"></div><p class="text-xs text-gray-500">Buscando...</p></div>
                <div id="forgotCodeMessageDiv" class="message-placeholder p-3 rounded-md text-sm mt-3 hidden"></div>
                <div id="recoveredCodeMailtoContainer" class="hidden mt-3"></div>
            </div>
        </div>
    </div>
    
</body>
</html>
