<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tent Cowork - Check-in/Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Configuración de Firebase (reemplaza con tus datos si aún no lo has hecho)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyC7Onnquc6p2_luPU_f9e9M0ltJ4eCXxp4",
            authDomain: "tentcowork-estudiantes.firebaseapp.com",
            projectId: "tentcowork-estudiantes",
            storageBucket: "tentcowork-estudiantes.firebasestorage.app",
            messagingSenderId: "229032189557",
            appId: "1:229032189557:web:acc8a34f6d7ba62020223c",
            measurementId: "G-RSL9JYPJ76"
        };

        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, updateDoc, serverTimestamp, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tent-cowork-checkin';
        
        // --- Selectores de Elementos del DOM ---
        const registrationSection = document.getElementById('registrationSection');
        const terminalSection = document.getElementById('terminalSection');
        const adminSection = document.getElementById('adminSection');
        const forgotCodeModal = document.getElementById('forgotCodeModal');
        const registrationForm = document.getElementById('registrationForm');
        const terminalForm = document.getElementById('terminalForm');
        const forgotCodeForm = document.getElementById('forgotCodeForm');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const codeDisplay = document.getElementById('codeDisplay');
        const mailtoButtonContainer = document.getElementById('mailtoButtonContainer');
        const studentStatusDiv = document.getElementById('studentStatusDiv');
        const adminContent = document.getElementById('adminContent');
        const closeOpenSessionsBtn = document.getElementById('closeOpenSessionsBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const terminalLoadingIndicator = document.getElementById('terminalLoadingIndicator');
        const forgotCodeLoadingIndicator = document.getElementById('forgotCodeLoadingIndicator');
        const adminLoadingIndicator = document.getElementById('adminLoadingIndicator');
        const forgotCodeMessageDiv = document.getElementById('forgotCodeMessageDiv');
        const adminMessageDiv = document.getElementById('adminMessageDiv');
        const recoveredCodeMailtoContainer = document.getElementById('recoveredCodeMailtoContainer');
        const showRegistrationBtn = document.getElementById('showRegistrationBtn');
        const showTerminalBtn = document.getElementById('showTerminalBtn');
        const openForgotCodeModalBtn = document.getElementById('openForgotCodeModalBtn');
        const closeForgotCodeModalBtn = document.getElementById('closeForgotCodeModalBtn');
        
        // --- Rutas de Colecciones de Firestore ---
        const studentsCollectionPath = `/artifacts/${appId}/public/data/students`;
        const sessionsCollectionPath = `/artifacts/${appId}/public/data/sessions`;

        // Configuración de Tailwind para colores personalizados
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tent-orange': '#F29F05',
                        'tent-green': '#014023',
                    }
                }
            }
        }

        // --- Lógica de Autenticación y Estado ---
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                // Esta función se ejecutará cada vez que el estado de autenticación cambie (login, logout)
                if (user && user.email) {
                    // Hay un usuario administrador con email logueado
                    console.log("Admin logueado:", user.email);
                    adminLoginForm.classList.add('hidden');
                    adminContent.classList.remove('hidden');
                } else {
                    // No hay admin logueado, o es un usuario anónimo
                    console.log("No hay admin logueado o es sesión anónima.");
                    adminLoginForm.classList.remove('hidden');
                    adminContent.classList.add('hidden');
                    // Si no hay ningún usuario (ni siquiera anónimo), iniciamos una sesión anónima
                    if (!auth.currentUser) {
                        signInAnonymously(auth).catch(error => console.error("Error en signInAnonymously:", error));
                    }
                }
            });
        }
        
        // --- Funciones de Utilidad UI ---
        function showLoading(indicator) { if (indicator) indicator.classList.remove('hidden'); }
        function hideLoading(indicator) { if (indicator) indicator.classList.add('hidden'); }

        function showMessage(targetMessageContainer, message, type = 'success') {
            if (!targetMessageContainer) return;
            targetMessageContainer.classList.remove('hidden', 'bg-green-100', 'text-tent-green', 'bg-red-100', 'text-red-700', 'bg-yellow-100', 'text-yellow-800');
            if (type === 'success') { targetMessageContainer.classList.add('bg-green-100', 'text-tent-green'); }
            else if (type === 'error') { targetMessageContainer.classList.add('bg-red-100', 'text-red-700'); }
            else { targetMessageContainer.classList.add('bg-yellow-100', 'text-yellow-800'); }
            targetMessageContainer.textContent = message;
            setTimeout(() => { targetMessageContainer.classList.add('hidden'); }, 7000); 
        }

        // --- Lógica de Navegación ---
        const tabButtonInactiveClasses = ['bg-gray-100', 'text-gray-500', 'hover:bg-gray-200', 'hover:text-gray-700', 'border-transparent'];
        const tabButtonActiveClasses = ['bg-tent-green', 'text-white', 'shadow-md', 'border-tent-orange'];

        function styleTabButton(button, isActive) {
            if (!button) return;
            button.classList.remove(...tabButtonActiveClasses, ...tabButtonInactiveClasses); 
            if (isActive) { button.classList.add(...tabButtonActiveClasses); }
            else { button.classList.add(...tabButtonInactiveClasses); }
        }

        function navigateTo(sectionName) {
            if(registrationSection) registrationSection.classList.add('hidden');
            if(terminalSection) terminalSection.classList.add('hidden');
            if(adminSection) adminSection.classList.add('hidden');

            styleTabButton(showRegistrationBtn, false); 
            styleTabButton(showTerminalBtn, false);

            if (sectionName === 'registration') {
                if(registrationSection) registrationSection.classList.remove('hidden');
                styleTabButton(showRegistrationBtn, true); 
            } else if (sectionName === 'admin') {
                if(adminSection) adminSection.classList.remove('hidden');
            } else { 
                if(terminalSection) terminalSection.classList.remove('hidden');
                styleTabButton(showTerminalBtn, true); 
            }
        }
        
        function handleInitialNavigation() {
            const params = new URLSearchParams(window.location.search);
            const view = params.get('view');
            navigateTo(view === 'register' ? 'registration' : (view === 'admin' ? 'admin' : 'terminal'));
        }
        
        // --- Funciones de Lógica de la Aplicación ---
        // (handleRegistrationSubmit, handleTerminalSubmit, etc.)
        function generateAccessCode() { return Math.floor(10000 + Math.random() * 90000).toString(); }
        async function handleRegistrationSubmit(event) { /* ...código sin cambios... */ }
        async function handleTerminalSubmit(event) { /* ...código sin cambios... */ }
        async function handleCheckStatus() { /* ...código sin cambios... */ }
        async function handleForgotCodeSubmit(event) { /* ...código sin cambios... */ }
        async function handleAdminLogin(event) {
            event.preventDefault();
            showLoading(adminLoadingIndicator);
            const email = adminLoginForm.adminEmail.value;
            const password = adminLoginForm.adminPassword.value;
            
            try {
                // Al iniciar sesión, onAuthStateChanged se activará y mostrará el panel correcto
                await signInWithEmailAndPassword(auth, email, password);
                showMessage(adminMessageDiv, 'Inicio de sesión exitoso.', 'success');
            } catch (error) {
                console.error("Error de inicio de sesión de admin:", error);
                let errorMessage = 'Email o contraseña incorrectos.';
                if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Las credenciales proporcionadas son incorrectas.';
                }
                showMessage(adminMessageDiv, errorMessage, 'error');
            } finally {
                hideLoading(adminLoadingIndicator);
            }
        }
        
        async function handleAdminLogout() {
            try {
                await signOut(auth);
                // onAuthStateChanged se activará y mostrará el formulario de login de nuevo
                showMessage(adminMessageDiv, 'Has cerrado sesión.', 'info');
            } catch (error) {
                console.error("Error al cerrar sesión de admin:", error);
                showMessage(adminMessageDiv, 'No se pudo cerrar sesión.', 'error');
            }
        }

        async function handleCloseOpenSessions() {
            if (!document.getElementById('confirmCloseCheckbox').checked) {
                showMessage(adminMessageDiv, 'Por favor, marca la casilla para confirmar la operación.', 'error');
                return;
            }
            showLoading(adminLoadingIndicator);
            try {
                const sessionsRef = collection(db, sessionsCollectionPath);
                const q = query(sessionsRef, where("checkOutTimestamp", "==", null));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage(adminMessageDiv, 'No se encontraron sesiones abiertas para cerrar.', 'info');
                } else {
                    const updatePromises = [];
                    const studentUpdateMap = new Map();
                    querySnapshot.forEach(sessionDoc => {
                        const session = sessionDoc.data();
                        const checkInDate = session.checkInTimestamp.toDate();
                        const closingDate = new Date(checkInDate);
                        closingDate.setHours(21, 30, 0, 0);
                        const durationMs = closingDate.getTime() - checkInDate.getTime();
                        const durationMinutes = Math.max(0, Math.round(durationMs / 60000));
                        updatePromises.push(updateDoc(doc(db, sessionsCollectionPath, sessionDoc.id), {
                            checkOutTimestamp: Timestamp.fromDate(closingDate),
                            durationMinutes: durationMinutes
                        }));
                        if (session.studentId) studentUpdateMap.set(session.studentId, false); 
                    });
                    studentUpdateMap.forEach((status, studentId) => {
                        updatePromises.push(updateDoc(doc(db, studentsCollectionPath, studentId), { isCheckedIn: status }));
                    });
                    await Promise.all(updatePromises);
                    showMessage(adminMessageDiv, `Cierre completado. Se actualizaron ${querySnapshot.size} sesiones.`, 'success');
                }
            } catch (error) {
                console.error("Error al cerrar sesiones abiertas:", error);
                showMessage(adminMessageDiv, 'Ocurrió un error durante el cierre de sesiones.', 'error');
            } finally {
                hideLoading(adminLoadingIndicator);
                document.getElementById('confirmCloseCheckbox').checked = false;
            }
        }
        
        // --- Inicialización y Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            setupAuthListener(); // Configurar el listener de autenticación UNA SOLA VEZ
            handleInitialNavigation(); 
            
            // ... (el resto de los listeners) ...
        });

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button-inactive { @apply bg-gray-100 text-gray-500 hover:bg-gray-200 hover:text-gray-700 border-transparent; }
        .tab-button-active { @apply bg-tent-green text-white shadow-md border-tent-orange; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4 selection:bg-tent-orange selection:text-white">
    <!-- El resto del HTML (el <body> completo) no cambia. Se incluye por completitud -->
    <div class="w-full max-w-md bg-white shadow-xl rounded-lg p-6 relative">
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-tent-orange">Tent Cowork</h1>
            <p class="text-gray-600">Sistema de Check-in / Check-out</p>
        </header>
        <div class="mb-4 border-b border-gray-300">
            <nav class="flex -mb-px">
                <button id="showTerminalBtn" class="px-6 py-3 font-semibold transition-all duration-150 ease-in-out focus:outline-none rounded-t-md border-b-2">Terminal</button>
                <button id="showRegistrationBtn" class="px-6 py-3 font-semibold transition-all duration-150 ease-in-out focus:outline-none rounded-t-md border-b-2">Registrarse</button>
            </nav>
        </div>
        
        <!-- Secciones de la App -->
        <section id="terminalSection" class="hidden pt-4"> <!-- ... Contenido de la sección terminal ... --> </section>
        <section id="registrationSection" class="hidden pt-4"> <!-- ... Contenido de la sección de registro ... --> </section>
        
        <!-- Sección de Administrador ACTUALIZADA -->
        <section id="adminSection" class="hidden pt-4">
            <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center">Panel de Administración</h2>
            <div class="message-placeholder p-3 rounded-md text-sm mb-4 hidden" id="adminMessageDiv"></div> 

            <!-- Formulario de Login de Admin -->
            <form id="adminLoginForm" class="space-y-4 bg-gray-50 p-4 rounded-lg border">
                <div>
                    <label for="adminEmail" class="block text-sm font-medium text-gray-700">Email de Administrador</label>
                    <input type="email" id="adminEmail" name="adminEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-tent-orange focus:border-tent-orange sm:text-sm" required>
                </div>
                <div>
                    <label for="adminPassword" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="adminPassword" name="adminPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-tent-orange focus:border-tent-orange sm:text-sm" required>
                </div>
                <button type="submit" class="w-full bg-tent-green hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all">
                    Iniciar Sesión
                </button>
            </form>

            <!-- Contenido de Admin (visible después del login) -->
            <div id="adminContent" class="hidden space-y-4">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 rounded-md" role="alert">
                  <p class="font-bold">Acción Crítica</p>
                  <p>Esta acción cerrará todas las sesiones que actualmente estén abiertas.</p>
                </div>
                <div class="flex items-center">
                    <input id="confirmCloseCheckbox" type="checkbox" class="h-4 w-4 text-tent-orange focus:ring-tent-orange border-gray-300 rounded">
                    <label for="confirmCloseCheckbox" class="ml-2 block text-sm text-gray-900">
                        Entiendo y quiero cerrar todas las sesiones abiertas.
                    </label>
                </div>
                <button type="button" id="closeOpenSessionsBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all">
                    Cerrar Sesiones Abiertas
                </button>
                <hr/>
                <button type="button" id="adminLogoutBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all text-sm">
                    Cerrar Sesión de Admin
                </button>
            </div>

            <div id="adminLoadingIndicator" class="text-center mt-4 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-red-600"></div>
                <p class="text-sm text-gray-500">Procesando...</p>
            </div>
        </section>

        <footer class="mt-8 text-center text-sm text-gray-500">
            <p>&copy; <span id="currentYear"></span> Tent Cowork. Todos los derechos reservados.</p>
        </footer>
    </div>
    
    <!-- Modal Olvidé mi Código -->
    <div id="forgotCodeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden"> <!-- ... Contenido del modal ... --> </div>

</body>
</html>
